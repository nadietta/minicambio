SELECT   pk_operazione,
         Date_format(o1.data_op,'%d/%m/%Y') AS data_op,
         v1.descrizione,
         o1.importo_entrata,
         v2.descrizione,
         o1.importo_uscita,
         tasso,
         cod_op,
         tipo_operazione ,
         tot_entrata,
         tot_uscita,
         mese,
         tot_entrata_mese,
         tot_uscita_mesefrom operazioni o1,
         valute                         v1,
         valute                         v2,
         (
                  SELECT   date(data_op) AS giorno,
                           fk_valuta_entrata,
                           fk_valuta_uscita,
                           sum(importo_entrata) AS tot_entrata,
                           sum(importo_uscita)  AS tot_uscita
                  FROM     operazioni
                  GROUP BY date(data_op),
                           fk_valuta_entrata,
                           fk_valuta_uscita) AS sub_query,
         (
                  SELECT   month(data_op) AS mese,
                           fk_valuta_entrata,
                           fk_valuta_uscita,
                           sum(importo_entrata) AS tot_entrata_mese,
                           sum(importo_uscita)  AS tot_uscita_mese
                  FROM     operazioni
                  GROUP BY month(data_op),
                           fk_valuta_entrata,
                           fk_valuta_uscita) AS sub_query2
WHERE    o1.fk_valuta_entrata = v1.pk_valuta
AND      o1.fk_valuta_uscita = v2.pk_valuta
AND      giorno=date(o1.data_op)
AND      sub_query.fk_valuta_entrata=o1.fk_valuta_entrata
AND      sub_query.fk_valuta_uscita=o1.fk_valuta_uscita
AND      mese=month(o1.data_op)
AND      sub_query2.fk_valuta_entrata=o1.fk_valuta_entrata
AND      sub_query2.fk_valuta_uscita=o1.fk_valuta_uscita
ORDER BY data_op, fk_valuta_entrata, fk_valuta_uscita